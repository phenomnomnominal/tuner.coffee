(function(){("undefined"!=typeof exports&&null!==exports?exports:this).Tuner=function(){var a;return a=function(a,b){return null==a&&(a="#Tuner"),null==b&&(b="light"),Tuner.Display.init(a,b),Tuner.mightWork?Tuner.Input.init():void 0}}()}).call(this),function(){Tuner.mightWork=function(){var a;return window.AudioContext=function(){return window.AudioContext||window.mozAudioContext||window.webkitAudioContext||window.msAudioContext||window.oAudioContext}(),AudioContext.prototype.createScriptProcessor=function(){return AudioContext.prototype.createScriptProcessor||AudioContext.prototype.createJavaScriptNode}(),navigator.getUserMedia=function(){return navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia}(),a=window.AudioContext&&navigator.getUserMedia}()}.call(this),function(){Tuner.Constants=function(){var a;return a=new AudioContext,{AUDIO_CONTEXT:a,SAMPLE_RATE:a.sampleRate,LOW_PASS_FREQUENCY:4e3,HIGH_PASS_FREQUENCY:20,FILTER_Q:.1,BUFFER_FILL_SIZE:2048,FFTSIZE:8192,REFERENCE_PITCH:440}}()}.call(this),function(){Tuner.DataBuffer=function(){var a,b,c,d,e,f,g,h,i,j;return a=function(){j=[];for(var a=0,b=Tuner.Constants.FFTSIZE;b>=0?b>a:a>b;b>=0?a++:a--)j.push(a);return j}.apply(this).map(function(){return 0}),b=Tuner.Constants.BUFFER_FILL_SIZE,i=0,h=a.length-Tuner.Constants.BUFFER_FILL_SIZE,g=Tuner.Constants.BUFFER_FILL_SIZE,f=a.length,e=a.length-Tuner.Constants.BUFFER_FILL_SIZE,d=a.length,c=Tuner.Constants.AUDIO_CONTEXT.createScriptProcessor(b),c.onaudioprocess=function(b){var c,j,k,l;return j=function(){var a,d,e,f;for(e=b.inputBuffer.getChannelData(0),f=[],a=0,d=e.length;d>a;a++)c=e[a],f.push(c);return f}(),[].splice.apply(a,[i,h-i].concat(k=a.slice(g,f))),k,[].splice.apply(a,[e,d-e].concat(l=j.slice(0,j.length))),l},a.filler=c,a}()}.call(this),function(){var a=[].slice,b=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};Tuner.Display=function(){var c,d,e,f,g;return d="https://github.com/phenomnomnominal/tuner.coffee",e={MarkUp:"<canvas></canvas>\n<div class='target'></div>\n<div class='dial'>\n  <div class='marker'></div>\n</div>\n<div class='note'>\n  <div class='name'></div>\n</div>\n<div class='help'>\n  <a href='"+d+"' target='_blank'>?</a>\n</div>",Fallback:"<div class='sorry'>\n  <div>\n    <h1>Sorry...</h1>\n    <p>Looks like you need a better browser to use this tuner.</p>\n  </div>\n</div>\n<div class='help'>\n  <a href='"+d+"' target='_blank'>?</a>\n</div>"},c=document.querySelector.bind(document),c.style=getComputedStyle.bind(window),c["class"]={add:function(b){var d;return d=c(b),function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],b.forEach(function(a){return d.classList.add(a)})}},remove:function(b){var d;return d=c(b),function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],b.forEach(function(a){return d.classList.remove(a)})}}},f=function(a,b){var d,f;return c["class"].add(a)("tuner",b),c(a).innerHTML=Tuner.mightWork?e.MarkUp:e.Fallback,f=function(){var b,d,e,f,g;return f=c.style(c(a)),e=parseInt(f.height,10),g=parseInt(f.width,10),b=c("canvas"),b&&(b.height=e,b.width=g),c["class"].remove(a)("small","medium","large"),420>g&&(d="small"),g>=420&&820>g&&(d="medium"),g>=820&&(d="large"),c["class"].add(a)(d)},addEventListener("resize",f),f(),d=c(".help a"),d.addEventListener("mouseover",function(){return d.innerText="tuner.coffee"}),d.addEventListener("mouseout",function(){return d.innerText="?"})},g=function(){var a,d,e,f;return d=function(){var a,b,d,e,f;for(d=c.style(document.documentElement),b=["transform","-moz-transform","mozTransform","MozTransform","-webkit-transform","webkitTransform","WebkitTransform","-o-transform","oTransform","OTransform","-ms-transform","msTransform","MsTransform"],e=0,f=b.length;f>e;e++)if(a=b[e],{}.hasOwnProperty.call(d,a)||null!=d[a])return a}(),f=function(a,e,f){var g,h,i,j,k;return c["class"].remove(".tuner")("tuned","untuned"),k=c(".name"),j=c(".marker").style,k.innerHTML="",null!=e&&null!=f?(Math.abs(f)<4?c["class"].add(".tuner")("tuned"):c["class"].add(".tuner")("untuned"),i=document.createElement("span"),i.textContent=e.substr(0,1),k.appendChild(i),b.call(e,"#")>=0&&(g=document.createElement("sup"),g.textContent="#",k.appendChild(g)),h=parseInt(c.style(c(".tuner")).height,10),j.setProperty(d,"translateY("+-(h/2)*f/50+"px)")):j.setProperty(d,"translateY(0px)")},a=0,e=function(b){var d,e,f,g,h,i,j,k,l,m,n;for(d=c("canvas"),e=d.getContext("2d"),e.clearRect(0,0,d.width,d.height),f=b.reduce(function(a,b){return null==a&&(a=0),Math.abs(b)>a?Math.abs(b):a}),a=f>a?f:a,h=d.height/b.length,e.fillStyle="#A5C7FD",n=[],g=l=0,m=b.length;m>=0?m>l:l>m;g=m>=0?++l:--l)k=h*g,i=d.width/3*(b[g]/a),j=d.width/2,n.push(e.fillRect(j,k,i,.5));return n},g=function(a,b,c){return f(a,b,c),e(a)}}(),{init:f,update:g}}()}.call(this),function(){Tuner.FFT=function(){var a;return a=function(){function a(a,b){var c,d,e,f,g=this;for(this.bufferSize=a,this.sampleRate=b,this.bandwidth=this.sampleRate/this.bufferSize,this.spectrum=new Float32Array(this.bufferSize/2),this.real=new Float32Array(this.bufferSize),this.imag=new Float32Array(this.bufferSize),this.reverseTable=new Uint32Array(this.bufferSize),d=1,c=a>>1;a>d;)(function(){e=[];for(var a=0;d>=0?d>a:a>d;d>=0?a++:a--)e.push(a);return e}).apply(this).forEach(function(a){return g.reverseTable[a+d]=g.reverseTable[a]+c}),d<<=1,c>>=1;this.sinTable=new Float32Array(this.bufferSize),this.cosTable=new Float32Array(this.bufferSize),function(){f=[];for(var b=0;a>=0?a>b:b>a;a>=0?b++:b--)f.push(b);return f}.apply(this).forEach(function(a){return g.sinTable[a]=Math.sin(-Math.PI/a),g.cosTable[a]=Math.cos(-Math.PI/a)})}return a.prototype.transform=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;for(b=this.bufferSize,e=this.cosTable,l=this.sinTable,k=this.reverseTable,j=this.real,g=this.imag,m=this.spectrum,f=1,function(){n=[];for(var a=0;b>=0?b>a:a>b;b>=0?a++:a--)n.push(a);return n}.apply(this).forEach(function(b){return j[b]=a[k[b]],g[b]=0});b>f;)i=e[f],h=l[f],d=1,c=0,function(){o=[];for(var a=0;f>=0?f>a:a>f;f>=0?a++:a--)o.push(a);return o}.apply(this).forEach(function(a){var e,k,l,m,n;for(e=a;b>e;)k=e+f,n=d*j[k]-c*g[k],l=d*g[k]+c*j[k],j[k]=j[e]-n,g[k]=g[e]-l,j[e]+=n,g[e]+=l,e+=f<<1;return m=d,d=m*i-c*h,c=m*h+c*i}),f<<=1;return this.calculateSpectrum()},a.prototype.calculateSpectrum=function(){var a,b,c,d,e,f;return d=this.spectrum,c=this.real,b=this.imag,a=2/this.bufferSize,e=Math.sqrt,function(){f=[];for(var a=0,b=this.bufferSize/2;b>=0?b>a:a>b;b>=0?a++:a--)f.push(a);return f}.apply(this).forEach(function(f){var g,h;return h=c[f],g=b[f],d[f]=a*e(h*h+g*g)})},a}(),new a(Tuner.Constants.FFTSIZE,Tuner.Constants.SAMPLE_RATE/4)}()}.call(this),function(){Tuner.Filter=function(){var a,b;return b=function(){var a;return a=Tuner.Constants.AUDIO_CONTEXT.createBiquadFilter(),a.type=a.LOWPASS,a.frequency=Tuner.Constants.LOW_PASS_FREQUENCY,a.Q=Tuner.Constants.FILTER_Q,a}(),a=function(){var a;return a=Tuner.Constants.AUDIO_CONTEXT.createBiquadFilter(),a.type=a.HIGHPASS,a.frequency=Tuner.Constants.HIGH_PASS_FREQUENCY,a.Q=Tuner.Constants.FILTER_Q,a}(),{LP:b,HP:a}}()}.call(this),function(){var a={}.hasOwnProperty;Tuner.frequencyUtils=function(){var b,c;return b=function(){var a,b;return b=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],a=[1,2,3,4,5,6,7],function(c){var d,e;return null==c&&(c=Tuner.Constants.REFERENCE_PITCH),d={},e=4,a.forEach(function(a){return b.forEach(function(b){var f;return f=b+a,d[f]=Math.pow(2,(e++-49)/12)*c})}),d}}(),c=function(b,c){var d,e,f,g,h,i,j;null==c&&(c=1/0),j=Tuner.frequencies;for(f in j)a.call(j,f)&&(i=j[f],Math.abs(b-i)<c&&(c=Math.abs(b-i),e=b-i,h=b/i,g=f));return d=1200*(Math.log(b/Tuner.frequencies[g])/Math.LN2),[g,d]},{createFrequencies:b,getPitch:c}}(),Tuner.frequencies=Tuner.frequencyUtils.createFrequencies()}.call(this),function(){Tuner.Gauss=function(){var a,b;return a=function(a,b,c,d,e){return null==c&&(c=.5),null==d&&(d=Math.pow),null==e&&(e=Math.E),d(e,-.5*d((b-(a-1)/2)/(c*(a-1)/2),2))},b=function(b,c){var d,e,f,g;for(e=b.length,g=[],d=f=0;e>=0?e>f:f>e;d=e>=0?++f:--f)g.push(b[d]*=a(e,d,c));return g},{process:b}}()}.call(this),function(){Tuner.Input=function(){var a,b,c;return b=function(){return navigator.getUserMedia({audio:!0},c,a)},c=function(a){var b,c;return b=Tuner.Constants.AUDIO_CONTEXT,c=b.createMediaStreamSource(a),c.connect(Tuner.Filter.LP),Tuner.Filter.LP.connect(Tuner.Filter.HP),Tuner.Filter.HP.connect(Tuner.DataBuffer.filler),Tuner.DataBuffer.filler.connect(b.destination),setInterval(Tuner.PitchDetection.process,100)},a=function(a){return console.error(a)},window.onerror=a,{init:b}}()}.call(this),function(){Tuner.NoiseRemoval=function(){var a,b,c;return c=0,a=-1/0,b=function(b){return 10>c?(a=b.reduce(function(b,c){return null==b&&(b=a),c>b?c:b}),a=a>.001?.001:a,c++):Tuner.NoiseRemoval.limit=a},{process:b}}()}.call(this),function(){Tuner.PitchDetection=function(){var a,b,c,d,e,f;return a=Tuner.Constants.SAMPLE_RATE/Tuner.Constants.FFTSIZE,e=0,d=0,b=Tuner.DataBuffer,c=Tuner.FFT,f=function(){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;if(f=b.slice(0,b.length),Tuner.Gauss.process(f),r=f.map(function(a,b){return b%4?0:a}),c.transform(r),u=function(){var a,b,d,e;for(d=c.spectrum,e=[],a=0,b=d.length;b>a;a++)s=d[a],e.push(s);return e}(),u=u.slice(0,u.length/4),Tuner.NoiseRemoval.limit||Tuner.NoiseRemoval.process(u),v=u.map(function(a,b){return{x:b,y:a}}),v.sort(function(a,b){return b.y-a.y}),o=v.slice(0,8).filter(function(a){return a.y>Tuner.NoiseRemoval.limit}),!(o.length>0&&Tuner.NoiseRemoval.limit))return e=0,d++,Tuner.Display.update(f);for(m=x=0,z=o.length;z>=0?z>x:x>z;m=z>=0?++x:--x)for(p=y=0,A=o.length;A>=0?A>y:y>A;p=A>=0?++y:--y)m!==p&&Math.abs((null!=(B=o[m])?B.x:void 0)-(null!=(C=o[p])?C.x:void 0))<5&&o.splice(p,1);return o.sort(function(a,b){return a.x-b.x}),e=e<o.length?o.length:e,e>0&&(d=0),h=o[0].x*a,o.length>1&&(t=o[1].x*a,1.4<(D=h/t)&&1.6>D&&(n=o[1])),o.length>2&&(w=o[2].x*a,1.4<(E=h/w)&&1.6>E&&(n=o[2])),o.length>1||1===e?(null==n&&(n=o[0]),k={x:n.x-1,y:Math.log(u[n.x-1])},m={x:n.x,y:Math.log(u[n.x])},q={x:n.x+1,y:Math.log(u[n.x+1])},j=.5*((k.y-q.y)/(k.y-2*m.y+q.y))+m.x,i=j*a,F=Tuner.frequencyUtils.getPitch(i),l=F[0],g=F[1],Tuner.Display.update(f,l,g)):void 0},{process:f}}()}.call(this);